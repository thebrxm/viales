<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAME - Dashboard Interactivo Profesional</title>
    
    <!-- Librer√≠as -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --bg: #2b3a51; --orange: #f5a65b; --white: #ffffff; --navy: #242f48; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: white; min-height: 100vh; }
        
        header { background: white; padding: 10px 50px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .logo { height: 60px; }

        main { padding: 40px; }

        /* HERO AREA */
        .hero { display: flex; gap: 40px; margin-bottom: 40px; align-items: flex-start; }
        
        .orange-box { background: var(--orange); color: #333; padding: 25px; border-radius: 15px; width: 420px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .orange-box h2 { margin: 0 0 10px; font-size: 1.3rem; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; text-transform: uppercase; }
        .orange-box p { font-size: 0.95rem; line-height: 1.5; font-weight: 500; }

        .title-section h1 { font-size: 2.8rem; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .subtitle { font-size: 1.1rem; opacity: 0.8; margin: 10px 0 20px; }
        
        select { padding: 12px; border-radius: 8px; background: #1a2436; color: white; border: 1px solid rgba(255,255,255,0.2); font-weight: bold; width: 250px; cursor: pointer; font-size: 1rem; }

        /* DASHBOARD GRID */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; max-width: 1300px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 20px; color: #333; min-height: 280px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column; }
        .card h3 { margin: 0 0 15px; font-size: 0.8rem; color: #777; text-transform: uppercase; border-left: 4px solid var(--orange); padding-left: 10px; }
        .chart-wrap { flex-grow: 1; position: relative; min-height: 180px; }

        /* ESTILO LISTA COMUNAS */
        .comuna-row { margin-bottom: 15px; }
        .comuna-info { display: flex; justify-content: space-between; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: var(--navy); }
        .progress-bg { background: #eee; height: 10px; border-radius: 5px; overflow: hidden; }
        .progress-fill { background: var(--orange); height: 100%; border-radius: 5px; width: 0%; transition: width 1s ease-in-out; }

        /* PICO FRECUENCIA */
        .pico-val { text-align: center; margin: auto 0; }
        .pico-dia { font-size: 3rem; color: #e74c3c; font-weight: bold; }
        .pico-hora { color: #555; font-size: 1.3rem; margin-top: 5px; }

        footer { padding: 30px 50px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px; font-size: 0.85rem; opacity: 0.7; }
        .btn-lang { background: white; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-left: 5px; }
    </style>
</head>
<body>

    <header>
        <img src="https://i.imgur.com/GXTFolo.png" alt="SAME" class="logo">
        <img src="https://i.imgur.com/W5Mo4rc.png" alt="ECUES" class="logo">
    </header>

    <main>
        <div class="hero">
            <div class="orange-box">
                <h2>Informe mensual</h2>
                <p id="txt-parrafo">Cargando datos del PDF...</p>
                <a id="lnk-pdf" href="#" target="_blank" style="color:#333; font-size: 0.8rem; font-weight:bold;">üìÑ VER PDF COMPLETO</a>
            </div>

            <div class="title-section">
                <h1>INCIDENTES DE TR√ÅNSITO</h1>
                <p class="subtitle">Monitoreo de incidentes viales atendidos por el equipo SAME / ECUES.</p>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <label style="font-size:0.7rem; font-weight:bold; opacity: 0.7;">PERIODO</label>
                    <select id="sel-periodo" onchange="cargarPDF(this.value)"></select>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Gr√°fico 1 -->
            <div class="card">
                <h3>Tipos de Incidentes (%)</h3>
                <div class="chart-wrap"><canvas id="c1"></canvas></div>
            </div>

            <!-- Gr√°fico 2 -->
            <div class="card">
                <h3>Participaci√≥n Vehicular (Casos)</h3>
                <div class="chart-wrap"><canvas id="c2"></canvas></div>
            </div>

            <!-- Dise√±o Nuevo para Comunas -->
            <div class="card">
                <h3>Distribuci√≥n por Comuna</h3>
                <div id="comuna-list" style="margin-top:10px;">
                    <!-- Se llena con JS -->
                </div>
            </div>

            <!-- Pico -->
            <div class="card">
                <h3>Pico de Frecuencia</h3>
                <div class="pico-val">
                    <div class="pico-dia" id="p-dia">---</div>
                    <div class="pico-hora" id="p-hora">--:-- hs</div>
                </div>
            </div>

            <!-- Comparativa -->
            <div class="card">
                <h3>Solicitudes vs Pacientes</h3>
                <div class="chart-wrap"><canvas id="c4"></canvas></div>
            </div>

            <!-- Mapa -->
            <div class="card" style="justify-content:center; align-items:center;">
                <h3>Mapa Interactivo</h3>
                <button style="background:var(--navy); color:white; padding:18px 35px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; font-size:1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.2);" onclick="window.open('https://same-ecues.github.io/VIALES-2025-ECUES/index.enero.2026.html')">üåê ABRIR MAPA INTERACTIVO</button>
            </div>
        </div>
    </main>

    <footer>
        <div>SAME / ECUES (Equipo de Comunicaci√≥n Unificada en Emergencias Sanitarias)</div>
        <div>
            <button class="btn-lang">ES</button>
            <button class="btn-lang">EN</button>
            <button class="btn-lang">PT</button>
        </div>
    </footer>

    <script>
        // --- CONFIGURACI√ìN DE PERIODOS (A√±ade aqu√≠ tus PDFs) ---
        const periodos = ["2025-12", "2026-01"];

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let charts = {};

        function init() {
            const sel = document.getElementById('sel-periodo');
            periodos.sort().reverse().forEach(p => {
                const o = document.createElement('option');
                o.value = p; o.innerHTML = p; sel.appendChild(o);
            });
            cargarPDF(periodos[0]);
        }

        async function cargarPDF(mes) {
            const url = `reportes/${mes}.pdf`;
            document.getElementById('lnk-pdf').href = url;
            try {
                const res = await fetch(url);
                const data = await res.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data}).promise;
                let fullText = "";
                for(let i=1; i<=pdf.numPages; i++){
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    fullText += content.items.map(item => item.str).join(" ");
                }
                procesar(fullText);
            } catch (e) { document.getElementById('txt-parrafo').innerText = "Archivo reportes/" + mes + ".pdf no encontrado."; }
        }

        function procesar(t) {
            const texto = t.replace(/\s+/g, ' ');

            // 1. Extraer primer p√°rrafo (En el mes de... pacientes.)
            const mP = texto.match(/(En el mes de.*?pacientes\.)/i);
            document.getElementById('txt-parrafo').innerText = mP ? mP[1] : "Resumen no disponible.";

            // 2. Extraer Veh√≠culos desde "Del total de incidentes registrados..."
            const sVehicular = texto.match(/Del total de incidentes registrados.*?(autom√≥viles corresponden a (\d+)).*?(motoveh√≠culos, (\d+)).*?(representan (\d+) casos)/i);
            const aut = sVehicular ? sVehicular[2] : 0;
            const mot = sVehicular ? sVehicular[4] : 0;
            const atr = sVehicular ? sVehicular[6] : 0;

            // 3. Extraer Tipos desde "El tipo de incidente m√°s frecuente..."
            const sTipos = texto.match(/El tipo de incidente m√°s frecuente.*?(Auto-Moto \((\d+,\d+)%\)).*?(auto ‚Äì auto \((\d+,\d+)%\)).*?(moto \((\d+,\d+)%\)).*?(atropellamientos \((\d+,\d+)%\))/i);
            const p1 = sTipos ? parseFloat(sTipos[3].replace(',','.')) : 0;
            const p2 = sTipos ? parseFloat(sTipos[5].replace(',','.')) : 0;
            const p3 = sTipos ? parseFloat(sTipos[7].replace(',','.')) : 0;
            const p4 = sTipos ? parseFloat(sTipos[9].replace(',','.')) : 0;

            // Solicitudes vs Pacientes
            const sol = texto.match(/total de (\d+) solicitudes/i) ? texto.match(/total de (\d+) solicitudes/i)[1] : 0;
            const pac = texto.match(/total de (\d+) pacientes/i) ? texto.match(/total de (\d+) pacientes/i)[1] : 0;

            // Pico
            const d = texto.match(/los (\w+) entre/i) ? texto.match(/los (\w+) entre/i)[1] : "---";
            const h = texto.match(/entre las (\d+) y las (\d+)/i) ? `${texto.match(/entre las (\d+) y las (\d+)/i)[1]}:00 ‚Äî ${texto.match(/entre las (\d+) y las (\d+)/i)[2]}:00 hs` : "--:--";
            document.getElementById('p-dia').innerText = d;
            document.getElementById('p-hora').innerText = h;

            dibujar(sol, pac, aut, mot, atr, [p1, p2, p3, p4]);
            dibujarComunas(); // Renderiza la lista visual
        }

        function dibujarComunas() {
            const list = document.getElementById('comuna-list');
            const data = [
                {n: "Comuna 1", v: "100%", p: 100},
                {n: "Comuna 9", v: "85%", p: 85},
                {n: "Comuna 14", v: "75%", p: 75},
                {n: "Comuna 4", v: "65%", p: 65}
            ];
            
            list.innerHTML = data.map(c => `
                <div class="comuna-row">
                    <div class="comuna-info"><span>${c.n}</span><span>${c.v}</span></div>
                    <div class="progress-bg"><div class="progress-fill" style="width:${c.p}%"></div></div>
                </div>
            `).join('');
        }

        function dibujar(sol, pac, aut, mot, atr, tipos) {
            if(charts.c1) Object.values(charts).forEach(c => c.destroy());
            const opt = { maintainAspectRatio: false, plugins: { legend: { display: false } } };

            charts.c1 = new Chart(document.getElementById('c1'), {
                type: 'bar', data: { labels: ['Auto-Moto', 'Auto-Auto', 'Ca√≠do Moto', 'Atropellado'], datasets: [{ data: tipos, backgroundColor: '#242f48' }] }, options: opt
            });

            charts.c2 = new Chart(document.getElementById('c2'), {
                type: 'doughnut', data: { labels: ['Autos', 'Motos', 'Atropellos'], datasets: [{ data: [aut, mot, atr], backgroundColor: ['#e74c3c', '#f5a65b', '#27ae60'] }] }, options: { maintainAspectRatio: false }
            });

            charts.c4 = new Chart(document.getElementById('c4'), {
                type: 'bar', data: { labels: ['Solicitudes', 'Pacientes'], datasets: [{ data: [sol, pac], backgroundColor: '#27ae60' }] }, options: opt
            });
        }

        window.onload = init;
    </script>
</body>
</html>
