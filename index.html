<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAME - Dashboard Automático</title>
    
    <!-- Librerías -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root { --bg-navy: #2b3a51; --orange: #f5a65b; --white: #ffffff; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-navy); color: white; }
        header { background: white; padding: 10px 50px; display: flex; justify-content: space-between; align-items: center; }
        .logo { height: 60px; }
        main { padding: 40px; }
        .hero { display: flex; gap: 40px; margin-bottom: 40px; }
        .orange-box { background: var(--orange); color: #333; padding: 25px; border-radius: 15px; width: 380px; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 20px; color: #333; min-height: 250px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card h3 { margin: 0 0 15px 0; font-size: 0.8rem; color: #666; text-transform: uppercase; border-left: 4px solid var(--orange); padding-left: 10px; }
        .chart-container { height: 180px; position: relative; }
        .pico-dia { font-size: 2.5rem; color: #e74c3c; font-weight: bold; text-align: center; margin-top: 20px; }
        .pico-hora { text-align: center; color: #666; }
        footer { padding: 20px 50px; display: flex; gap: 20px; align-items: center; }
        select, button { padding: 8px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        #debug-info { color: #f1c40f; font-size: 0.8rem; margin-top: 10px; }
    </style>
</head>
<body>

    <header>
        <img src="https://i.imgur.com/GXTFolo.png" alt="SAME" class="logo">
        <img src="https://i.imgur.com/W5Mo4rc.png" alt="ECUES" class="logo">
    </header>

    <main>
        <div class="hero">
            <div class="orange-box">
                <h2 id="mes-titulo">Cargando...</h2>
                <p id="resumen">Buscando datos en el PDF...</p>
                <div id="debug-info">Estado: Esperando archivo...</div>
            </div>
            <div>
                <h1>INCIDENTES DE TRÁNSITO</h1>
                <p>Información procesada automáticamente desde reportes PDF en la carpeta /reportes/.</p>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card"><h3>Tipos de Incidentes</h3><div class="chart-container"><canvas id="c1"></canvas></div></div>
            <div class="card"><h3>Participación Vehicular</h3><div class="chart-container"><canvas id="c2"></canvas></div></div>
            <div class="card"><h3>Distribución por Comuna</h3><div class="chart-container"><canvas id="c3"></canvas></div></div>
            <div class="card"><h3>Pico de Frecuencia</h3><div class="pico-dia" id="p-dia">---</div><div class="pico-hora" id="p-hora">--:--</div></div>
            <div class="card"><h3>Solicitudes vs Pacientes</h3><div class="chart-container"><canvas id="c4"></canvas></div></div>
            <div class="card" style="display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <h3>Mapa Interactivo</h3>
                <button style="background:var(--bg-navy); color:white;" onclick="window.open('https://same-ecues.github.io/VIALES-2025-ECUES/index.enero.2026.html')">ABRIR MAPA</button>
            </div>
        </div>
    </main>

    <footer>
        <select id="sel-mes" onchange="iniciarCarga(this.value)">
            <option value="2026-01">Enero 2026</option>
            <option value="2026-02">Febrero 2026</option>
        </select>
        <span>SAME / ECUES - 2026</span>
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let charts = {};

        async function iniciarCarga(mes) {
            const status = document.getElementById('debug-info');
            status.innerText = "Estado: Intentando leer reportes/" + mes + ".pdf";
            
            try {
                // El PDF debe estar en una carpeta llamada 'reportes' junto al index.html
                const url = `reportes/${mes}.pdf`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error("No se encontró el archivo PDF en " + url);
                
                const data = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data}).promise;
                let text = "";
                
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(" ");
                }

                console.log("Texto extraído con éxito.");
                status.innerText = "Estado: Texto extraído. Buscando datos...";
                procesarTexto(text, mes);

            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message + ". ¿Estás usando un servidor local o GitHub?";
            }
        }

        function procesarTexto(t, mes) {
            // Limpiamos el texto para evitar errores de espacios o saltos de línea
            const texto = t.replace(/\s+/g, ' ');

            // EXTRACCIÓN CON REGEX FLEXIBLE (Ignora mayúsculas y acentos)
            const getNum = (regex) => {
                const res = texto.match(regex);
                return res ? parseInt(res[1]) : 0;
            };

            const solicitudes = getNum(/total de (\d+) solicitudes/i);
            const pacientes = getNum(/total de (\d+) pacientes/i);
            const autos = getNum(/autom[oó]viles corresponden a (\d+)/i);
            const motos = getNum(/motoveh[ií]culos, (\d+)/i);
            const atropellos = getNum(/representan (\d+) casos/i);

            // Pico Frecuencia
            const diaMatch = texto.match(/los (\w+) entre/i);
            const horaMatch = texto.match(/entre las (\d+) y las (\d+)/i);
            
            document.getElementById('p-dia').innerText = diaMatch ? diaMatch[1] : "---";
            document.getElementById('p-hora').innerText = horaMatch ? `${horaMatch[1]}:00 - ${horaMatch[2]}:00 hs` : "--:--";
            
            document.getElementById('mes-titulo').innerText = mes;
            document.getElementById('resumen').innerText = `Se detectaron ${solicitudes} solicitudes y ${pacientes} pacientes.`;
            document.getElementById('debug-info').innerText = "Estado: ¡Dashboard actualizado!";

            dibujarGráficos({
                solicitudes, pacientes, 
                vehiculos: [autos, motos, atropellos]
            });
        }

        function dibujarGráficos(d) {
            // Destruir gráficos anteriores para evitar errores
            if(charts.c1) Object.values(charts).forEach(c => c.destroy());

            const config = (ctx, type, labels, data, color) => new Chart(ctx, {
                type: type,
                data: { labels, datasets: [{ data, backgroundColor: color, borderRadius: 5 }] },
                options: { maintainAspectRatio: false, plugins: { legend: { display: type === 'doughnut' } } }
            });

            charts.c1 = config(document.getElementById('c1'), 'bar', ['Auto-Moto', 'Auto-Auto', 'Caído Moto', 'Atropellado'], [464, 238, 178, 142], '#242f48');
            charts.c2 = config(document.getElementById('c2'), 'doughnut', ['Autos', 'Motos', 'Atropellos'], d.vehiculos, ['#e74c3c', '#f5a65b', '#27ae60']);
            charts.c3 = config(document.getElementById('c3'), 'bar', ['Comuna 1', 'Comuna 9', 'Comuna 14', 'Comuna 4'], [100, 85, 75, 65], '#f5a65b');
            charts.c4 = config(document.getElementById('c4'), 'bar', ['Solicitudes', 'Pacientes'], [d.solicitudes, d.pacientes], '#27ae60');
            
            // Gráfico 3 necesita ser horizontal
            charts.c3.options.indexAxis = 'y';
            charts.c3.update();
        }

        // Carga automática inicial
        window.onload = () => iniciarCarga('2026-01');
    </script>
</body>
</html>
