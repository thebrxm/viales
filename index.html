<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAME - Dashboard de Incidentes</title>
    
    <!-- Librer√≠as: Gr√°ficos y Procesamiento de PDF -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
        :root {
            --bg-navy: #2b3a51;
            --orange-card: #f5a65b;
            --white-card: #ffffff;
            --header-bg: #ffffff;
            --text-gray: #555;
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-navy);
            color: white;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* HEADER */
        header {
            background-color: var(--header-bg);
            padding: 10px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo { height: 60px; }

        /* SECCI√ìN PRINCIPAL */
        main { padding: 40px; flex-grow: 1; }

        .hero {
            display: flex;
            gap: 50px;
            margin-bottom: 50px;
            align-items: flex-start;
        }

        /* Cuadro Naranja */
        .orange-box {
            background-color: var(--orange-card);
            color: #333;
            padding: 25px;
            border-radius: 15px;
            width: 420px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            min-height: 200px;
        }
        .orange-box h2 { margin: 0 0 15px 0; font-size: 1.4rem; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px;}
        .orange-box p { font-size: 1rem; line-height: 1.5; margin-bottom: 20px; font-weight: 500; }
        .pdf-link { color: #333; font-weight: bold; text-decoration: underline; font-size: 0.9rem; }

        /* T√≠tulo y Selector */
        .title-section h1 { font-size: 2.8rem; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .title-section .subtitle { font-size: 1.1rem; opacity: 0.9; margin: 10px 0 25px 0; }
        
        .period-container { display: flex; flex-direction: column; gap: 5px; }
        .period-container label { font-size: 0.75rem; font-weight: bold; opacity: 0.8; text-transform: uppercase; }
        
        select {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background: #1a2436;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            width: 200px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* GRID DE GR√ÅFICOS */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            max-width: 1250px;
            margin: 0 auto;
        }

        .card {
            background: var(--white-card);
            border-radius: 15px;
            padding: 20px;
            color: #333;
            min-height: 260px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .card h3 {
            margin: 0 0 15px 0;
            font-size: 0.85rem;
            color: var(--text-gray);
            text-transform: uppercase;
            border-left: 4px solid var(--orange-card);
            padding-left: 10px;
        }

        .chart-container { height: 180px; position: relative; }

        /* PICO FRECUENCIA */
        .pico-data { text-align: center; margin-top: 30px; }
        .pico-dia { font-size: 2.8rem; color: #e74c3c; font-weight: bold; }
        .pico-hora { font-size: 1.2rem; color: #666; }

        /* FOOTER */
        footer { padding: 30px 50px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.1); margin-top: 20px;}
        .btn-lang { padding: 6px 12px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; background: white; color: #333; margin-left: 5px;}
        
        #loader { font-style: italic; font-size: 0.9rem; color: #333; }
    </style>
</head>
<body>

    <header>
        <img src="https://i.imgur.com/GXTFolo.png" alt="SAME" class="logo">
        <img src="https://i.imgur.com/W5Mo4rc.png" alt="ECUES" class="logo">
    </header>

    <main>
        <div class="hero">
            <!-- CUADRO NARANJA -->
            <div class="orange-box">
                <h2>Informe mensual</h2>
                <p id="parrafo-pdf"><span id="loader">Cargando resumen del reporte...</span></p>
                <a id="pdf-url" href="#" target="_blank" class="pdf-link">Ver informe completo</a>
            </div>

            <!-- T√çTULO Y SELECTOR -->
            <div class="title-section">
                <h1>INCIDENTES DE TR√ÅNSITO</h1>
                <p class="subtitle">Monitoreo de incidentes viales atendidos por el equipo SAME / ECUES.</p>
                
                <div class="period-container">
                    <label>Periodo</label>
                    <select id="selector-periodo" onchange="cargarPDF(this.value)">
                        <option value="2026-01">Enero 2026</option>
                        <option value="2026-02">Febrero 2026</option>
                        <!-- Agregar m√°s opciones aqu√≠ mensualmente -->
                    </select>
                </div>
            </div>
        </div>

        <!-- GR√ÅFICOS -->
        <div class="dashboard-grid">
            <div class="card">
                <h3>Tipos de Incidentes</h3>
                <div class="chart-container"><canvas id="c1"></canvas></div>
            </div>
            <div class="card">
                <h3>Participaci√≥n Vehicular</h3>
                <div class="chart-container"><canvas id="c2"></canvas></div>
            </div>
            <div class="card">
                <h3>Distribuci√≥n por Comuna</h3>
                <div class="chart-container"><canvas id="c3"></canvas></div>
            </div>
            <div class="card">
                <h3>Pico de Frecuencia</h3>
                <div class="pico-data">
                    <div class="pico-dia" id="p-dia">---</div>
                    <div class="pico-hora" id="p-hora">--:-- ‚Äî --:-- hs</div>
                </div>
            </div>
            <div class="card">
                <h3>Solicitudes vs Pacientes</h3>
                <div class="chart-container"><canvas id="c4"></canvas></div>
            </div>
            <div class="card" style="display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <h3>Mapa Interactivo</h3>
                <button class="btn-lang" style="background:#242f48; color:white; padding: 15px 30px; border-radius: 10px;" onclick="window.open('https://same-ecues.github.io/VIALES-2025-ECUES/index.enero.2026.html')">üåê VER MAPA</button>
            </div>
        </div>
    </main>

    <footer>
        <div style="font-size: 0.85rem; opacity: 0.7;">
            SAME / ECUES (Equipo de Comunicaci√≥n Unificada en Emergencias Sanitarias)
        </div>
        <div>
            <button class="btn-lang">ES</button>
            <button class="btn-lang">EN</button>
            <button class="btn-lang">PT</button>
        </div>
    </footer>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let charts = {};

        async function cargarPDF(mes) {
            const url = `reportes/${mes}.pdf`; // Los archivos deben estar en la carpeta /reportes/
            document.getElementById('pdf-url').href = url;
            document.getElementById('parrafo-pdf').innerHTML = '<span id="loader">Extrayendo informaci√≥n...</span>';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error("No se encontr√≥ el archivo");
                
                const data = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({data}).promise;
                
                let textoCompleto = "";
                for(let i=1; i<=pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    textoCompleto += content.items.map(item => item.str).join(" ");
                }
                
                procesarYMostrar(textoCompleto);
            } catch (e) {
                document.getElementById('parrafo-pdf').innerText = "Error: Aseg√∫rate de que el archivo PDF est√© en la carpeta /reportes/ de tu servidor.";
            }
        }

        function procesarYMostrar(textoRaw) {
            const texto = textoRaw.replace(/\s+/g, ' ');

            // 1. Extraer primer p√°rrafo (Desde "En el mes de" hasta el primer punto seguido de "pacientes")
            const regexParrafo = /(En el mes de.*?pacientes\.)/i;
            const matchParrafo = texto.match(regexParrafo);
            document.getElementById('parrafo-pdf').innerText = matchParrafo ? matchParrafo[1] : "No se pudo extraer el resumen del PDF.";

            // 2. Extraer N√∫meros para Gr√°ficos
            const solicitudes = texto.match(/total de (\d+) solicitudes/i) ? texto.match(/total de (\d+) solicitudes/i)[1] : 0;
            const pacientes = texto.match(/total de (\d+) pacientes/i) ? texto.match(/total de (\d+) pacientes/i)[1] : 0;
            const autos = texto.match(/autom√≥viles corresponden a (\d+)/i) ? texto.match(/autom√≥viles corresponden a (\d+)/i)[1] : 0;
            const motos = texto.match(/motoveh√≠culos, (\d+)/i) ? texto.match(/motoveh√≠culos, (\d+)/i)[1] : 0;
            const atropellos = texto.match(/representan (\d+) casos/i) ? texto.match(/representan (\d+) casos/i)[1] : 0;

            // 3. Pico Frecuencia
            const dia = texto.match(/los (\w+) entre/i) ? texto.match(/los (\w+) entre/i)[1] : "---";
            const hora = texto.match(/entre las (\d+) y las (\d+)/i) ? `${texto.match(/entre las (\d+) y las (\d+)/i)[1]}:00 ‚Äî ${texto.match(/entre las (\d+) y las (\d+)/i)[2]}:00 hs` : "--:--";
            
            document.getElementById('p-dia').innerText = dia;
            document.getElementById('p-hora').innerText = hora;

            dibujarTodo(solicitudes, pacientes, autos, motos, atropellos);
        }

        function dibujarTodo(sol, pac, aut, mot, atr) {
            if(charts.c1) Object.values(charts).forEach(c => c.destroy());

            const baseOptions = { maintainAspectRatio: false, plugins: { legend: { display: false } } };

            charts.c1 = new Chart(document.getElementById('c1'), {
                type: 'bar',
                data: { labels: ['Auto-Moto', 'Auto-Auto', 'Ca√≠do Moto', 'Atropellado'], datasets: [{ data: [464, 238, 178, 142], backgroundColor: '#242f48' }] },
                options: baseOptions
            });

            charts.c2 = new Chart(document.getElementById('c2'), {
                type: 'doughnut',
                data: { labels: ['Autos', 'Motos', 'Atropellos'], datasets: [{ data: [aut, mot, atr], backgroundColor: ['#e74c3c', '#f5a65b', '#27ae60'] }] },
                options: { maintainAspectRatio: false }
            });

            charts.c3 = new Chart(document.getElementById('c3'), {
                type: 'bar',
                data: { labels: ['C1', 'C9', 'C14', 'C4'], datasets: [{ data: [100, 85, 75, 65], backgroundColor: '#f5a65b' }] },
                options: { indexAxis: 'y', ...baseOptions }
            });

            charts.c4 = new Chart(document.getElementById('c4'), {
                type: 'bar',
                data: { labels: ['Solicitudes', 'Pacientes'], datasets: [{ data: [sol, pac], backgroundColor: '#27ae60' }] },
                options: baseOptions
            });
        }

        // Carga inicial (Enero)
        window.onload = () => cargarPDF('2026-01');
    </script>
</body>
</html>
